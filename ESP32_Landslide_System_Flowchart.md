# 🏔️ ระบบตรวจสอบดินถล่ม ESP32 - Flowchart รวมทั้งระบบ

## 📊 แผนผังการทำงานทั้งระบบ

```
                         🚀 เริ่มต้นระบบ
                              ↓
                    ┌─────────────────────────┐
                    │     เริ่มต้นฮาร์ดแวร์      │
                    │  • Serial (115200 bps)  │
                    │  • I2C (SDA=21,SCL=22)  │
                    │  • PTFS Power & Reset    │
                    │  • UART2 (115200 bps)   │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │    เริ่มต้น MPU6050      │
                    │  • ตั้งช่วง ±2g         │
                    │  • ตั้งช่วง ±250°/s     │
                    │  • ทดสอบการเชื่อมต่อ     │
                    └─────────────────────────┘
                              ↓
                         ตรวจสอบ MPU6050
                              ↓
                    ┌─────────────────────────┐
                    │      คาลิเบรต MPU6050    │
                    │   • 3,000 ตัวอย่าง      │
                    │   • 30 วินาที           │
                    │   • คำนวณ Offset        │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │      ตั้งค่า BLE         │
                    │   • สร้าง Server        │
                    │   • สร้าง Service       │
                    │   • เริ่มโฆษณา          │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │    เริ่มการวัด PTFS      │
                    │   • ส่งคำสั่งเริ่มวัด     │
                    │   • เปิดใช้งาน Buffer    │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │      ระบบพร้อมใช้งาน     │
                    │   🎯 เริ่มลูปหลัก        │
                    └─────────────────────────┘
                              ↓
        ╔═══════════════════════════════════════════════════════════╗
        ║                      🔄 ลูปหลัก (Main Loop)                ║
        ╚═══════════════════════════════════════════════════════════╝
                              ↓
                    ┌─────────────────────────┐
                    │   ให้อาหาร Watchdog      │
                    │      (ทุก 1 วินาที)      │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   ตรวจสอบสุขภาพระบบ     │
                    │      (ทุก 5 วินาที)      │
                    │ • MPU6050 Health        │
                    │ • PTFS Health           │
                    │ • BLE Health            │
                    │ • Memory Check          │
                    └─────────────────────────┘
                              ↓
                         นับข้อผิดพลาด
                              ↓
                    ┌─────────────────────────┐
                    │   ข้อผิดพลาด ≥ 10?      │
                    └─────────────────────────┘
                         ↓ ใช่        ↓ ไม่ใช่
                    ┌─────────┐           ↓
                    │ รีสตาร์ท │           ↓
                    │  ESP32  │           ↓
                    └─────────┘           ↓
                                          ↓
                    ┌─────────────────────────┐
                    │   ประมวลผลข้อมูล PTFS    │
                    │ • อ่าน UART2 Buffer    │
                    │ • วิเคราะห์โปรโตคอล     │
                    │ • หาค่าระยะทางที่ถูกต้อง │
                    │ • ใช้ Moving Average    │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   ส่งคำสั่ง PTFS        │
                    │      (ทุก 2 วินาที)      │
                    │ • ส่งคำสั่งเริ่มวัด      │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   อ่านข้อมูล MPU6050     │
                    │ • รับ Motion6 Data      │
                    │ • ใช้ค่า Offset         │
                    │ • แปลงเป็นหน่วยทางกายภาพ │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   คำนวณมุมเงยมืออาชีพ    │
                    │ • คำนวณ Data Quality    │
                    │ • ใช้ atan2() สำหรับมุม │
                    │ • ใช้ Complementary     │
                    │   Filter (α=0.98)      │
                    │ • จำกัดช่วง ±90°        │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │     แสดงผลลัพธ์         │
                    │ • มุมเงย (°)            │
                    │ • ระยะทาง (m)           │
                    │ • คุณภาพข้อมูล (%)      │
                    │ • สถานะการเชื่อมต่อ      │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │    ส่งข้อมูล BLE        │
                    │      (ทุก 1 วินาที)      │
                    └─────────────────────────┘
                              ↓
                         อุปกรณ์เชื่อมต่อ?
                              ↓
                    ┌─────────────────────────┐
                    │      ใช่ - ส่งข้อมูล     │
                    │ • elevation:XX          │
                    │ • distance:X.X          │
                    │ • quality:XX.X          │
                    │ • mode:X                │
                    │ • END                   │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │  จัดการการเชื่อมต่อ BLE   │
                    │ • ตรวจสอบการตัดการเชื่อมต่อ│
                    │ • เริ่มโฆษณาใหม่         │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   รีเซ็ตฮาร์ดแวร์ PTFS   │
                    │      (ทุก 5 นาที)        │
                    │ • Reset Pin Low/High    │
                    │ • เปิดใช้งานใหม่         │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │      หน่วงเวลา 10ms     │
                    │    yield() & delay()    │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │      กลับไปลูปหลัก      │
                    │         ↻ Loop         │
                    └─────────────────────────┘
                              ↑
                              │
                              └──────────────────────────────────────┘

        ╔═══════════════════════════════════════════════════════════╗
        ║                 📡 การประมวลผลข้อมูล PTFS                  ║
        ╚═══════════════════════════════════════════════════════════╝

                    ┌─────────────────────────┐
                    │     รับข้อมูล UART2      │
                    │   เก็บใน Buffer 200B    │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   วิเคราะห์โปรโตคอล      │
                    │ 1. PTFS Protocol        │
                    │    (0xFB 0x03)         │
                    │ 2. TOF Protocol         │
                    │    (0x5A)              │
                    │ 3. 9600bps Format       │
                    │    (0x80 0x0C 0x08)    │
                    │ 4. 16-bit Search        │
                    │ 5. Single Byte          │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │    หาค่าที่ถูกต้อง       │
                    │ • นับความถี่แต่ละค่า     │
                    │ • เลือกค่าที่บ่อยที่สุด   │
                    │ • ตรวจสอบช่วง 30-10000dm│
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │    ใช้ตัวกรองข้อมูล      │
                    │ • Moving Average 30ตัวอย่าง│
                    │ • ล้างข้อมูลผิดปกติ      │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │     อัปเดตระยะทาง       │
                    │ • < 3m → 0m (ใกล้เกินไป)│
                    │ • 3-1000m → ใช้ค่าจริง   │
                    │ • > 1000m → 0m (ไกลเกินไป)│
                    │ • 0m → ไม่มีวัตถุ        │
                    └─────────────────────────┘

        ╔═══════════════════════════════════════════════════════════╗
        ║               📐 การคำนวณมุมเงย MPU6050                    ║
        ╚═══════════════════════════════════════════════════════════╝

                    ┌─────────────────────────┐
                    │    อ่านข้อมูล Motion6    │
                    │   ax, ay, az, gx, gy, gz│
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │    ใช้ค่า Calibration    │
                    │ • ax -= ax_offset       │
                    │ • ay -= ay_offset       │
                    │ • az -= az_offset       │
                    │ • gx -= gx_offset       │
                    │ • gy -= gy_offset       │
                    │ • gz -= gz_offset       │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   แปลงเป็นหน่วยทางกายภาพ │
                    │ • Accel: /16384.0 (g)  │
                    │ • Gyro: /131.0 (°/s)   │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   คำนวณคุณภาพข้อมูล      │
                    │ • ตรวจสอบขนาดความเร่ง   │
                    │ • ตรวจสอบขนาด Gyro     │
                    │ • ให้คะแนน 0-100%       │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   คำนวณมุมเงยจาก Accel  │
                    │ • |Ax| > 0.95? → 90°   │
                    │ • อื่นๆ: atan2(Ax, YZ)  │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │  ใช้ Complementary Filter│
                    │ • α=0.98 (Gyro weight)  │
                    │ • β=0.02 (Accel weight) │
                    │ • รวม: α*gyro + β*accel │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │     จำกัดช่วงมุม        │
                    │   -90° ≤ มุม ≤ +90°     │
                    └─────────────────────────┘

        ╔═══════════════════════════════════════════════════════════╗
        ║                   🔵 การสื่อสาร BLE                       ║
        ╚═══════════════════════════════════════════════════════════╝

                    ┌─────────────────────────┐
                    │   ตรวจสอบการเชื่อมต่อ    │
                    │      deviceConnected    │
                    └─────────────────────────┘
                              ↓
                         เชื่อมต่อแล้ว?
                              ↓
                    ┌─────────────────────────┐
                    │      ใช่ - ส่งข้อมูล     │
                    │                        │
                    │ 1. elevation:+XX        │
                    │    (มุมเงย/ก้ม)         │
                    │                        │
                    │ 2. distance:XX.X        │
                    │    (ระยะทางเมตร)        │
                    │                        │
                    │ 3. quality:XX.X         │
                    │    (คุณภาพ %)           │
                    │                        │
                    │ 4. mode:X               │
                    │    (โหมดการทำงาน)       │
                    │                        │
                    │ 5. END                  │
                    │    (สัญญาณจบ)          │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   จัดการการตัดการเชื่อมต่อ│
                    │ • ตรวจสอบ oldConnected  │
                    │ • เริ่มโฆษณาใหม่         │
                    │ • แสดงสถานะ             │
                    └─────────────────────────┘

        ╔═══════════════════════════════════════════════════════════╗
        ║              ⚠️ การจัดการข้อผิดพลาด                        ║
        ╚═══════════════════════════════════════════════════════════╝

                    ┌─────────────────────────┐
                    │   ตรวจสอบสุขภาพ MPU6050  │
                    │   testConnection()      │
                    └─────────────────────────┘
                              ↓
                         ตอบสนอง?
                    ┌─────────────────────────┐
                    │ ใช่ → mpu6050Healthy=true│
                    │ ไม่ → errorCount++      │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   ตรวจสอบสุขภาพ PTFS    │
                    │  มีข้อมูลใน 10 วินาที?   │
                    └─────────────────────────┘
                              ↓
                         มีข้อมูล?
                    ┌─────────────────────────┐
                    │ ใช่ → ptfsHealthy=true  │
                    │ ไม่ → errorCount++      │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   ตรวจสอบสุขภาพ BLE     │
                    │  Server & Char OK?     │
                    └─────────────────────────┘
                              ↓
                           OK?
                    ┌─────────────────────────┐
                    │ ใช่ → bleHealthy=true   │
                    │ ไม่ → errorCount++      │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   ตรวจสอบหน่วยความจำ    │
                    │   ESP.getFreeHeap()    │
                    └─────────────────────────┘
                              ↓
                         > 10KB?
                    ┌─────────────────────────┐
                    │ ใช่ → OK                │
                    │ ไม่ → แสดงคำเตือน        │
                    └─────────────────────────┘
                              ↓
                    ┌─────────────────────────┐
                    │   ตรวจสอบจำนวนข้อผิดพลาด│
                    │     errorCount ≥ 10?    │
                    └─────────────────────────┘
                              ↓
                         ≥ 10?
                    ┌─────────────────────────┐
                    │ ใช่ → ESP.restart()     │
                    │ ไม่ → errorCount = 0    │
                    └─────────────────────────┘

```

## 🎯 คุณสมบัติหลักของระบบ

### 📐 การวัดมุมเงยแบบมืออาชีพ
- **ความแม่นยำ**: ±0.1° ด้วย Complementary Filter
- **ช่วงการวัด**: -90° ถึง +90°
- **อัตราการสุ่ม**: 100 Hz
- **การคาลิเบรต**: 3,000 ตัวอย่าง
- **ไม่เปลี่ยนแปลงเมื่อเอียง**: Roll Independent

### 📏 การวัดระยะทาง PTFS
- **ช่วงการวัด**: 3-1000 เมตร
- **โปรโตคอล**: รองรับหลายรูปแบบ
- **ตัวกรองข้อมูล**: Moving Average 30 ตัวอย่าง
- **การตรวจสอบ**: ตรวจสอบความถูกต้องแบบเรียลไทม์

### 📊 การประเมินคุณภาพ
- **คะแนนคุณภาพ**: 0-100%
- **ตรวจสอบความเร่ง**: ควรใกล้ 1g
- **ตรวจสอบ Gyro**: ควรต่ำเมื่ออยู่นิ่ง
- **การแจ้งเตือน**: เตือนเมื่อคุณภาพต่ำ

### 🔵 การสื่อสาร BLE
- **ความถี่การส่ง**: ทุก 1 วินาที
- **รูปแบบข้อมูล**: elevation, distance, quality, mode
- **การจัดการ**: Auto-reconnection
- **ความเสถียร**: ตรวจสอบการเชื่อมต่อต่อเนื่อง

### ⚠️ การจัดการข้อผิดพลาด
- **การตรวจสอบ**: ทุก 5 วินาที
- **Auto-restart**: เมื่อข้อผิดพลาด ≥ 10 ครั้ง
- **การตรวจสอบหน่วยความจำ**: แจ้งเตือนเมื่อต่ำ
- **Hardware Reset**: รีเซ็ต PTFS ทุก 5 นาที

## 📋 สรุปการทำงาน

ระบบนี้ถูกออกแบบมาเพื่อการตรวจสอบดินถล่มแบบมืออาชีพ โดยมีการทำงานแบบต่อเนื่อง 24/7 พร้อมระบบตรวจสอบและแก้ไขข้อผิดพลาดอัตโนมัติ ให้ข้อมูลที่แม่นยำและเชื่อถือได้สำหรับการเฝ้าระวังการเคลื่อนตัวของดินและการเปลี่ยนแปลงของภูมิประเทศ
